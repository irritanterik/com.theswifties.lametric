<!doctype html>
<html>
<head>
    <meta http-equiv="Cache-Control" content="no-store" />
    <script type="text/javascript" src="/manager/webserver/assets/js/jquery.js"></script>
</head>
<body>
    <h1>Lametric Time Settings</h1>

    <fieldset>
        <legend><span>Add LaMetric Time devices</span></legend>
        <p><b>Step 1</b> - Obtain your device API's from the <a href="https://developer.lametric.com" target="_blank">LaMetric developer site</a>.</p>
        <p><b>Step 2</b> - Enter your device information in the table below. The nickname is used to identify devices on the action card.</p>
        <p><b>How do find icon numbers?</b> - You can specify an icon on the action card, icon ID's can be found <a href="https://developer.lametric.com/icons" target="_blank">here</a>. Enter the number only, the '#' is not required.</p>
        <p>I've made a Homey icon (3715) which is displayed on the action card icon field for quick reference.</p>
        <div class="field row">
            <label style="width: 260px;"><span>Device IP address</span></label>
            <label style="width: 260px;"><span>Device API key</span></label>
            <label><span>Device Nickname</span></label>
        </div>
        <div class="field row new_lametric">
            <input class="lametric_ip" name="lametric_ips[]" type="text" value=""/>
            <input class="lametric_api" name="lametric_apis[]" type="text" value=""/>
            <input class="lametric_name" name="lametric_names[]" type="text" value=""/>
        </div>
        <div class="field row add_lametric">
            <button id="add" class="left" onclick="addLametric()">Add device</button>
        </div>
    </fieldset>

    <button id="save" class="left" onclick="saveSettings()">Save settings</button>

    <script type="text/javascript">
        function onHomeyReady() {
            // We're ready!
            Homey.ready();

            // Hide some elements initially.
            $("#row-auto-discovered").hide();

            // Fill input with already stored settings.
            Homey.get("lametrics", function (err, lametrics) {
                //Homey.log(lametrics);
                if (lametrics) {
                    for (var i = 0; i < lametrics.length; i++) {
                        var lametric = lametrics[i];
                        var newLametric = $(".new_lametric").clone();
                        newLametric.removeClass("new_lametric");
                        $(".lametric_ip", newLametric).val(lametric.ip);
                        $(".lametric_api", newLametric).val(lametric.api);
                        $(".lametric_name", newLametric).val(lametric.name)
                        newLametric.insertBefore(".new_lametric");
                    }
                }
            });
        }

        function addLametric() {
            var newLametric = $(".new_lametric").clone();
            newLametric.removeClass("new_lametric");
            $(".lametric_ip", newLametric).val("");
            $(".lametric_api", newLametric).val("");
            $(".lametric_name", newLametric).val("");
            newLametric.insertBefore(".add_lametric");
            $(".lametric_ip", newLametric).focus();
        }

        function saveSettings() {
            // Update running app with new settings (PUT to api).
            console.log("Saving settings...");

            var lametricIPs = $('input[name^=lametric_ips]').map(function (idx, elem) {
                return $(elem).val();
            }).get();

            var lametricAPIs = $('input[name^=lametric_apis]').map(function (idx, elem) {
                return $(elem).val();
            }).get();
            
            var lametricNAMES = $('input[name^=lametric_names]').map(function (idx, elem) {
                return $(elem).val();
            }).get()

            var settings = {};
            var lametrics = [];
            for (var i = 0; i < lametricAPIs.length; i++) {
                if (lametricIPs[i].length > 0 && lametricAPIs[i].length > 0 && lametricNAMES[i].length > 0) {
                    lametrics.push({ ip: lametricIPs[i], api: lametricAPIs[i], name: lametricNAMES[i] });
                }
            }

            settings.lametrics = lametrics;

            Homey.api("PUT", "/settings/", settings, function (err, success) {
                if (success) {
                    console.log("Settings saved successfull.");

                    // Display successful update of settings.
                    setSaveButton("green", "white", __("Settings saved!"));

                    // Store settings for the long term.
                    Homey.set("lametrics", lametrics);
                } else {
                    console.log("Saving settings failed.");

                    // Display failed registration
                    setSaveButton("lightcoral", "black", __("Settings failed!"));
                }

                resetSaveButton();
            });
        }

        function resetSaveButton() {
            setTimeout(function() {
                setSaveButton("", "black", __("settings.save"));
            }, 3000);
        }

        function setSaveButton(backgroundColor, color, innerHtml) {
            var btnSave = document.getElementById("save");
            btnSave.style["background-color"] = backgroundColor;
            btnSave.style["color"] = color;
            btnSave.innerHTML = innerHtml;
        }
    </script>
</body>
</html>